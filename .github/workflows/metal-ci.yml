name: Metal CI

on:
  push:
    branches: [ main ]
    paths:
      - 'src/metal/**'
      - 'CMakeLists.txt'
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: System Info
      run: |
        system_profiler SPHardwareDataType
        xcodebuild -version
        
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_METAL=ON \
          -DDISABLE_OPENCL=ON
    
    - name: Build
      run: cmake --build build --config Release -- -j $(sysctl -n hw.ncpu)
    
    - name: Test Metal Shaders
      run: ./scripts/test_metal.sh
    
    - name: Validate Audio
      run: python3 scripts/validate_audio.py
    
    - name: Run Benchmarks
      run: ./scripts/benchmark.sh
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          build/Testing/
          output/*.wav

name: Doc Gate (advisory)
on:
  pull_request:
    branches: [ main ]
permissions:
  pull-requests: write
jobs:
  doc-gate:
    runs-on: ubuntu-latest
    env:
      DOC_ENFORCE: ${{ vars.DOC_ENFORCE || 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: gate
        run: |
          python3 - <<'PY'
          import json, os, re, subprocess, sys
          base = os.environ.get("GITHUB_BASE_REF", "main")
          
          # In GitHub Actions PR context, find the merge base
          try:
              # Try to find merge-base with origin/base
              merge_base = subprocess.check_output(
                  ["git", "merge-base", "HEAD", f"origin/{base}"],
                  text=True, stderr=subprocess.DEVNULL
              ).strip()
              diff = subprocess.check_output(
                  ["git", "diff", "--name-only", merge_base, "HEAD"],
                  text=True, stderr=subprocess.DEVNULL
              )
          except subprocess.CalledProcessError:
              # Fallback 1: try direct diff against origin/base
              try:
                  diff = subprocess.check_output(
                      ["git", "diff", "--name-only", f"origin/{base}...HEAD"],
                      text=True, stderr=subprocess.DEVNULL
                  )
              except subprocess.CalledProcessError:
                  # Fallback 2: use HEAD~N to get recent changes
                  try:
                      # Get all commits until we find one not from this PR
                      diff = subprocess.check_output(
                          ["git", "diff", "--name-only", "HEAD~5", "HEAD"],
                          text=True, stderr=subprocess.DEVNULL
                      )
                  except subprocess.CalledProcessError:
                      # Last resort: list all files
                      diff = subprocess.check_output(["git", "ls-files"], text=True)
          
          files = [line.strip() for line in diff.splitlines() if line.strip()]
          event_path = os.environ.get("GITHUB_EVENT_PATH", "")
          pr_body = ""
          labels = []
          if event_path:
              with open(event_path, "r", encoding="utf-8") as fh:
                  ev = json.load(fh)
              pr = ev.get("pull_request", {})
              pr_body = pr.get("body") or ""
              labels = [lab.get("name", "") for lab in pr.get("labels", [])]
          touches_docs = any(path.startswith("docs/") for path in files)
          cites_ap = bool(re.search(r"\bAP-[A-Z]+-\d+\b", pr_body or ""))
          enforce = (os.getenv("DOC_ENFORCE", "false") == "true") or ("require-doc" in labels)
          if touches_docs or cites_ap:
              print("[doc-gate] OK: docs touched o AP citato")
              sys.exit(0)
          msg = "Doc advisory: aggiungi 'Relates: AP-...' o aggiorna docs/ se utile. (Consulta, non blocca)"
          if enforce:
              print("::error::" + msg + " â€” enforced (label 'require-doc' o DOC_ENFORCE=true)")
              sys.exit(2)
          else:
              print("::notice::" + msg)
              sys.exit(0)
          PY

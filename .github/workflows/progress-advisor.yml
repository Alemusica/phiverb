name: Progress Advisor (consultivo)
on:
  pull_request:
    types: [opened, edited, synchronize]
  issue_comment:
    types: [created]
permissions:
  pull-requests: write
jobs:
  advise-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner; const repo = context.repo.repo;
            const files = await github.paginate(github.rest.pulls.listFiles, {owner, repo, pull_number: pr.number});
            const paths = files.map(f => f.filename);
            const touchesRT = paths.some(p => p.startsWith('src/raytracer/'));
            const touchesDWM = paths.some(p => p.startsWith('src/waveguide/'));
            const touchesDocs = paths.some(p => p === 'docs/action_plan.md');
            const hasAP = /relates:\s*ap-[a-z]+-\d+/i.test(pr.body || '');
            let notes = [];
            if ((touchesRT || touchesDWM) && !hasAP) notes.push('Add `Relates: AP-...` to PR body (Action Plan ID).');
            if ((touchesRT || touchesDWM) && !touchesDocs) notes.push('Update `docs/action_plan.md` checklist if you closed items.');
            if (touchesRT && !/brdf|diffuse|mis/i.test(pr.body || '')) notes.push('Confirm BRDF/diffuse-rain/MIS status in PR body (short).');
            if (touchesDWM && !/soa|pcs|guard/i.test(pr.body || '')) notes.push('Confirm SoA/PCS/Guardâ€‘Tag status in PR body (short).');
            if (notes.length) {
              await github.rest.issues.createComment({owner, repo, issue_number: pr.number, body: 'Progress advisor (consultivo):\n- ' + notes.join('\n- ')});
            }
  advise-comment:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment.body || '').trim();
            const owner = context.repo.owner; const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const lower = body.toLowerCase();
            if (!lower.startsWith('rt said:') && !lower.startsWith('dwm said:')) return;
            const note = lower.startsWith('rt said:')
              ? 'If no PR draft exists, open one at 20% with `Relates: AP-RT-00X`. Push changes under `src/raytracer/` to trigger CI `rt-tests`.'
              : 'If no PR draft exists, open one at 20% with `Relates: AP-DWM-00X`. Push changes under `src/waveguide/` to trigger CI `dwm-tests`.';
            await github.rest.issues.createComment({owner, repo, issue_number, body: note});

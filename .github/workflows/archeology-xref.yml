name: Archeology XRef (consultiva)
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    - cron: '17 03 * * *'
permissions:
  contents: write
  pull-requests: write
jobs:
  xref:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run XRef
        run: |
          python3 tools/docs_refresh.py
      - name: Commit to main if possible
        if: github.event_name == 'push'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/archeology.md docs/action_plan.md analysis/comment_summary.md || true
          git diff --cached --quiet || git commit -m "docs: auto-xref (nightly/main)" || true
          git push || true
      - name: Comment in PR (summary only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('analysis/comment_summary.md','utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.number,
              body: "### Autoâ€‘XRef (consultivo)\n\n" + body.slice(0, 60000)
            });

name: Agent Iteration Router (consultivo)
on:
  issue_comment:
    types: [created]
permissions:
  pull-requests: write
  issues: write
jobs:
  route:
    if: github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Route and reply
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body || '';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            function reply(text){
              return github.rest.issues.createComment({ owner, repo, issue_number, body: text });
            }

            const header = body.trim().split('\n')[0].toLowerCase();
            if (header.startsWith('rt said:')) {
              const text = [
                'RT Iteration received. Next steps:',
                '',
                '- Build/test: `cmake -S . -B build && cmake --build build -j`, `ctest --test-dir build --output-on-failure` (filter legacy if needed).',
                '- Shoebox QA: `python3 scripts/qa/run_validation_suite.py --cli build/bin/wayverb_cli --scenes tests/scenes` (±1 sample / ±0.5 dB).',
                '- Push touching `src/raytracer/` to trigger CI `rt-tests`. If shared code changed, run Metal smoke (runner macOS/ARM64).',
                '- Open a draft PR (20%) with `Relates: AP-RT-00X`; use Token‑Guard before long outputs; checkpoint 20/60/80/90%.',
                '',
                'Docs: `AGENTS.md`, `docs/AGENT_PROMPTS.md`, `docs_source/boundary.md`, `docs/action_plan.md`.'
              ].join('\n');
              await reply(text);
            } else if (header.startsWith('dwm said:')) {
              const text = [
                'DWM Iteration received. Next steps:',
                '',
                '- Priorità: SoA + boundary unico (Morton) → PCS trasparente → Guard‑Tag/NaN fail‑fast.',
                '- Build/test: `cmake -S . -B build && cmake --build build -j`, `ctest --test-dir build --output-on-failure`.',
                '- QA/regressioni: `python3 scripts/qa/run_validation_suite.py --cli build/bin/wayverb_cli --scenes tests/scenes`, `tools/run_regression_suite.sh` con `WAYVERB_ALLOW_SILENT_FALLBACK=0` (allega log).',
                '- Push `src/waveguide/` per attivare CI `dwm-tests`. Se tocchi shared kernel, esegui Metal smoke (runner macOS/ARM64).',
                '- Apri PR (draft 20%) con `Relates: AP-DWM-00X`, Token‑Guard/checkpoint.',
                '',
                'Docs: `AGENTS.md`, `docs/AGENT_PROMPTS.md`, `docs_source/boundary.md`, `docs/action_plan.md`.'
              ].join('\n');
              await reply(text);
            }
